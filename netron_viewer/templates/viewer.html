<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ project_name }} ONNX Model Viewer</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Custom styling adjustments */
        body {
            font-family: Arial, sans-serif;
            background-color: #f9fafb;
            color: #333;
            padding: 20px;
        }
        .title {
            font-size: 2em;
            color: #0073e6;
            text-align: center;
            margin-bottom: 20px;
        }
        .model-card h2 {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 10px;
        }
        .btn-container {
            text-align: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="title">{{ project_name }} ONNX Model Viewer</div>

    <div class="row row-cols-1 row-cols-md-3 g-4">
        {% for index, model_name in enumerate(model_names) %}
        <div class="col">
            <div class="card model-card shadow-sm">
                <div class="card-body text-center">
                    <h2 class="card-title">{{ model_name }}</h2>
                    <button class="btn btn-primary mb-2 w-100" onclick="openModel('{{ index }}')">Open</button>
                    <button class="btn btn-danger mb-2 w-100" onclick="closeModel('{{ index }}')">Close</button>
                    <button class="btn btn-warning w-100" onclick="compareModel('{{ index }}')">Compare</button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="btn-container">
        <button class="btn btn-success me-2" onclick="showAllOpen()">Show All Open</button>
        <button class="btn btn-secondary" onclick="closeAll()">Close All</button>
        <button class="btn btn-outline-danger" onclick="reset()">Reset and Go to Setup</button>
    </div>
</div>

<script>
    const netronWindows = {};  // Track open windows with model indices as keys
    const basePort = {{ netron_start_port }};  // Retrieve base port from session

    function openModel(index, compare = false, width = null, height = null, left = null, top = null) {
        const port = basePort + parseInt(index);  // Assign unique port for each model based on index
        const modelName = "{{ model_names[index] }}";  // Fetch the model name from template context

        if (!compare) closeAll();
        // Close existing window if it's open
        if (netronWindows[index] && !netronWindows[index].closed) {
            netronWindows[index].close();
        }

        // Make an AJAX request to ensure the view_model route is called
        fetch(`/view/${index}`)
            .then(response => {
                if (response.ok) {
                    const url = `http://127.0.0.1:${port}/?url=${index}`;

                    // Set default size and position if none are provided
                    const screenWidth = window.screen.availWidth / 1.25;
                    const screenHeight = window.screen.availHeight;
                    if (width === null)
                        width = screenWidth;
                    if (height === null)
                        height = screenHeight;
                    if (left === null)
                        left = (screenWidth - width) / 2;
                    if (top === null)
                        top = (screenHeight - height) / 2;

                    // Open the window with specified dimensions and position
                    netronWindows[index] = window.open(
                        url,
                        `_blank`,
                        `width=${width},height=${height},left=${left},top=${top}`
                    );

                    // Wait for the window to open, then set its title
                    netronWindows[index].addEventListener('load', () => {
                        netronWindows[index].document.title = modelName;  // Set the title to model name
                    });
                } else {
                    console.error(`Failed to load model ${index}:`, response.statusText);
                }
            })
            .catch(error => console.error('Error:', error));
        return true;
    }

    function closeModel(index) {
        if (netronWindows[index] && !netronWindows[index].closed) {
            netronWindows[index].close();
            delete netronWindows[index];  // Remove from tracking
        }
    }

    async function compareModel(index) {
        // Open the model in comparison mode, calculate layout for all windows
        if (openModel(index, true))
            await delay(1500);
            showAllOpen();
    }

    function showAllOpen() {
        // Calculate and apply layout for all open windows
        layoutWindows();
    }

    // Helper function to delay execution
    function delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function layoutWindows() {
        // Filter and count currently open windows
        const openWindowIndices = Object.keys(netronWindows).filter(index => netronWindows[index] && !netronWindows[index].closed);
        const numWindows = openWindowIndices.length;

        if (numWindows === 0) return;

        // Calculate size and position based on number of open windows
        const screenWidth = window.screen.availWidth / 1.1;
        const screenHeight = window.screen.availHeight;
        const width = screenWidth / numWindows;
        const height = Math.floor(screenHeight);
        closeAll();
        await delay(2000);  // Wait 2s
        // Close and reopen each window with calculated dimensions and positions with a delay
        for (let i = 0; i < openWindowIndices.length; i++) {
            const index = openWindowIndices[i];
            const left = i * width;
            const top = 0;
            openModel(index, true, width, height, left, top);  // Reopen with new dimensions and position
            await delay(1500);  // Wait 1.5 s
        }
    }

    function closeAll() {
        // Close all open windows and clear the netronWindows tracking object
        Object.values(netronWindows).forEach(win => {
            if (win && !win.closed) {
                win.close();
            }
        });
        // Clear the tracking dictionary
        Object.keys(netronWindows).forEach(key => delete netronWindows[key]);
    }

    async function reset(){
        closeAll();
        await delay(1500);
        location.href="{{ url_for('reset') }}";
    }
</script>

<!-- Bootstrap JS (Optional for interactive components) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
