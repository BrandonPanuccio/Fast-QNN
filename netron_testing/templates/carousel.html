<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{project_name}} ONNX Model Viewer</title>
    <style>
        /* Global reset and body styling */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f9fafb;
            color: #333;
            padding: 20px;
        }

        /* Title styling */
        .title {
            font-size: 2em;
            color: #0073e6;
            text-align: center;
            margin-bottom: 20px;
        }

        /* Model grid styling */
        .model-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }

        /* Model card styling */
        .model-card {
            width: 200px;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .model-card h2 {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 10px;
        }

        /* Button styling */
        .button {
            display: block;
            margin: 5px 0;
            padding: 8px 12px;
            font-size: 0.9em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            color: #fff;
            width: 100%;
        }

        .button.open {
            background-color: #0073e6;
        }

        .button.close {
            background-color: #e63946;
        }

        .button.compare {
            background-color: #ff9f1c;
        }

        .button.show-all {
            background-color: #2a9d8f;
            width: auto;
            padding: 10px 20px;
            margin-top: 20px;
            font-size: 1em;
        }

        .button.close-all {
            background-color: #d9534f;
            width: auto;
            padding: 10px 20px;
            margin-top: 20px;
            font-size: 1em;
        }
    </style>
</head>
<body>
<div class="title">{{project_name}} ONNX Model Viewer</div>

<div class="model-grid">
    {% for index, model_name in enumerate(model_names) %}
    <div class="model-card">
        <h2>{{ model_name }}</h2>
        <button class="button open" onclick="openModel('{{ index }}')">Open</button>
        <button class="button close" onclick="closeModel('{{ index }}')">Close</button>
        <button class="button compare" onclick="compareModel('{{ index }}')">Compare</button>
    </div>
    {% endfor %}
</div>

<button class="button show-all" onclick="showAllOpen()">Show All Open</button>
<button class="button close-all" onclick="closeAll()">Close All</button>

<script>
    const netronWindows = {};  // Track open windows with model indices as keys

    function openModel(index, compare = false, width = null, height = null, left = null, top = null) {
        const port = 20123 + parseInt(index);  // Assign unique port for each model based on index
        const modelName = "{{ model_names[index] }}";  // Fetch the model name from template context

        if(!compare) closeAll()
        // Close existing window if it's open
        if (netronWindows[index] && !netronWindows[index].closed) {
            netronWindows[index].close();
        }

        // Make an AJAX request to ensure the view_model route is called
        fetch(`/view/${index}`)
            .then(response => {
                if (response.ok) {
                    const url = `http://127.0.0.1:${port}/?url=${index}`;

                    // Set default size and position if none are provided
                    const screenWidth = Math.floor(window.screen.availWidth/1.25);
                    const screenHeight = window.screen.availHeight;
                    width = width || screenWidth;
                    height = height || screenHeight;
                    left = left || Math.floor((screenWidth - width) / 2);
                    top = top || Math.floor((screenHeight - height) / 2);

                    // Open the window with specified dimensions and position
                    netronWindows[index] = window.open(
                        url,
                        `_blank_${index}`,
                        `width=${width},height=${height},left=${left},top=${top}`
                    );

                    // Wait for the window to open, then set its title
                    netronWindows[index].addEventListener('load', () => {
                        netronWindows[index].document.title = modelName;  // Set the title to model name
                    });
                } else {
                    console.error(`Failed to load model ${index}:`, response.statusText);
                }
            })
            .catch(error => console.error('Error:', error));
        return true;
    }

    function closeModel(index) {
        if (netronWindows[index] && !netronWindows[index].closed) {
            netronWindows[index].close();
            delete netronWindows[index];  // Remove from tracking
        }
    }

    function compareModel(index) {
        // Open the model in comparison mode, calculate layout for all windows
        if(openModel(index, true))
            showAllOpen();
    }

    function showAllOpen() {
        // Calculate and apply layout for all open windows
        layoutWindows();
    }

    function layoutWindows() {
        // Filter and count currently open windows
        const openWindowIndices = Object.keys(netronWindows).filter(index => netronWindows[index] && !netronWindows[index].closed);
        const numWindows = openWindowIndices.length;

        if (numWindows === 0) return;

        // Calculate size and position based on number of open windows
        const screenWidth = Math.floor(window.screen.availWidth/1.25);
        const screenHeight = window.screen.availHeight;
        const width = Math.floor(screenWidth / numWindows);
        const height = Math.floor(screenHeight);

        // Close and reopen each window with calculated dimensions and positions
        openWindowIndices.forEach((index, i) => {
            closeModel(index);  // Close existing window
            const left = i * width;
            const top = 0;
            openModel(index, true, width, height, left, top);  // Reopen with new dimensions and position
        });
    }

    function closeAll() {
        // Close all open windows and clear the netronWindows tracking object
        Object.values(netronWindows).forEach(win => {
            if (win && !win.closed) {
                win.close();
            }
        });
        // Clear the tracking dictionary
        Object.keys(netronWindows).forEach(key => delete netronWindows[key]);
    }
</script>



</body>
</html>